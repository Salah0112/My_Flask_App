<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TV Display Presentation</title>
    <!-- Include the main Reveal.js stylesheet -->
    <link rel="stylesheet" href="{{ url_for('static', filename='revealjs/dist/reveal.css') }}">
    <!-- Include Bootstrap Icons stylesheet -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.8.1/font/bootstrap-icons.min.css">
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: transparent;
        }
        .reveal {
            width: 100%;
            height: 100%;
        }
        .reveal .slides section {
            display: flex;
            justify-content: center;
            align-items: center;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            height: 100%;
            min-height: 100vh;
        }
        .exit-button, .fullscreen-button {
            position: fixed;
            top: 10px;
            left: 10px;
            padding: 8px 15px;
            font-size: 16px;
            background-color: gray;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            z-index: 1001; /* Ensure it's above Reveal.js elements */
        }
        .fullscreen-button {
            left: auto;
            right: 10px;

        }
        .fullscreen-button i {
            font-size: 24px; /* Adjust the size of the icon as needed */
        }
    </style>
</head>
<body>
<button class="exit-button" onclick="location.href='{{ url_for('TV_display_page') }}'">Exit Presentation</button>
<button class="fullscreen-button" onclick="toggleFullScreen()">
    <i class="bi bi-fullscreen"></i>
</button>
<div class="reveal">
    <div class="slides">
        {{ presentation_content | safe }} <!-- Safe rendering of presentation slides -->
    </div>
</div>
<!-- Include the Reveal.js library -->
<script src="{{ url_for('static', filename='revealjs/dist/reveal.js') }}"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script>
    function muteAllVideos() {
    document.querySelectorAll('video').forEach(video => {
        video.muted = true;
    });
}

    document.addEventListener('keydown', function(event) {
        if (event.key === 'F11') {
            event.preventDefault(); // Prevent the browser default F11 fullscreen
            toggleFullScreen();
             Reveal.resumeAutoSlide(); // Ensure auto-sliding continues
        }
    });

    function toggleFullScreen() {
        var doc = window.document;
        var docEl = doc.documentElement;

        var requestFullScreen = docEl.requestFullscreen || docEl.mozRequestFullScreen || docEl.webkitRequestFullScreen || docEl.msRequestFullscreen;
        var cancelFullScreen = doc.exitFullscreen || doc.mozCancelFullScreen || doc.webkitExitFullscreen || doc.msExitFullscreen;

        if (!doc.fullscreenElement && !doc.mozFullScreenElement && !doc.webkitFullscreenElement && !doc.msFullscreenElement) {
            requestFullScreen.call(docEl);
        } else {
            cancelFullScreen.call(doc);
        }
    }

    // Handle fullscreen changes to toggle the visibility of the exit and fullscreen buttons
    document.addEventListener('fullscreenchange', function() {
        var exitButton = document.querySelector('.exit-button');
        var fullscreenButton = document.querySelector('.fullscreen-button');
        if (document.fullscreenElement) {
            exitButton.style.display = 'none';
            fullscreenButton.style.display = 'none'; // Hide fullscreen button in fullscreen mode
        } else {
            exitButton.style.display = 'block';
            fullscreenButton.style.display = 'block'; // Show fullscreen button when not in fullscreen
             Reveal.resumeAutoSlide(); // Resume auto-sliding when exiting fullscreen
        }
    });
    document.addEventListener('DOMContentLoaded', function() {
        let tvId = {{ tv_id | tojson }};
        let currentContentHash = "{{ current_content_hash }}";
        let slide_Duration = 5000;  // Default slide duration if not fetched

        function checkForUpdates() {
            fetch(`/check_update/${tvId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.updated && data.content_hash !== currentContentHash) {
                        currentContentHash = data.content_hash;
                        console.log('Content has changed, reloading...');
                        location.reload(true); // Force reload to show updated content
                    } else {
                        console.log('No update found.');
                    }
                })
                .catch(error => console.error('Error checking for updates:', error));
        }
        setInterval(checkForUpdates, 6000); // Check for updates every 6 seconds

        // Initialize Reveal.js with autoSlide set to a default or fetched value
        Reveal.initialize({
            history: true,
            controls: true,
            center: true,
            hash: true,
            slideNumber: true,
            overview: true,
            loop: true,
            rtl: false,
            width: "100%",
            height: "100%",
            margin: 0,
            minScale: 1,
            maxScale: 1,
            transition: 'none',
            autoPlayMedia: true,
            autoSlide: 0,
            autoSlideStoppable: true

        });
        muteAllVideos()
        function goFullscreen() {
                var doc = window.document;
                var docEl = doc.documentElement;
                var requestFullScreen = docEl.requestFullscreen || docEl.mozRequestFullScreen || docEl.webkitRequestFullScreen || docEl.msRequestFullscreen;
                if (!doc.fullscreenElement && !doc.mozFullScreenElement && !doc.webkitFullscreenElement && !doc.msFullscreenElement) {
                        requestFullScreen.call(docEl);
                }
            }
        // Button click event listener for fullscreen toggle
        document.querySelector('.fullscreen-button').addEventListener('click', function() {
            goFullscreen();
        });

        window.addEventListener('beforeunload', function(event) {
            const url = '/stop_presentation';
            const data = new Blob([JSON.stringify({ status: tvId})], { type: 'application/json' });
            navigator.sendBeacon(url, data);
        });


        function pauseAllVideos() {
            document.querySelectorAll('video').forEach(video => {
                video.pause();
            });
        }

        function playVideosOnActiveSlide(slide) {
            const videos = slide.querySelectorAll('video');
            if (videos.length) {
                pauseAutoSlide(); // Pause auto-sliding
                Array.from(videos).forEach(video => {
                    video.currentTime = 0; // Ensure video starts from the beginning
                    video.play().catch(error => console.error("Error playing video:", error));
                });

                Promise.all(Array.from(videos).map(video => {
                    return new Promise(resolve => video.onended = resolve);
                })).then(() => {
                    resumeAutoSlide(slide_Duration); // Resume auto-sliding when all videos end
                });
            } else {
                resumeAutoSlide(slide_Duration); // Ensure auto-sliding is active if no videos
            }
        }

        function pauseAutoSlide() {
            Reveal.configure({ autoSlide: 0 });
        }

        function resumeAutoSlide(duration) {
            Reveal.configure({ autoSlide: duration });
        }

        // Fetch slide duration dynamically
        fetch(`/get_slideduration/${tvId}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error(data.error);
                } else {
                    slide_Duration = data.slideduration;
                    resumeAutoSlide(slide_Duration); // Apply fetched slide duration
                }
            })
            .catch(error => console.error('Error fetching slide duration:', error));

        // Reveal.js event listeners
        Reveal.on('ready', function(event) {
            pauseAllVideos() // Ensure all videos are paused initially
            playVideosOnActiveSlide(Reveal.getCurrentSlide())


        });

        Reveal.on('slidechanged', function(event) {
            pauseAllVideos(); // Pause all videos when slide changes
            playVideosOnActiveSlide(event.currentSlide); // Play videos only on the current slide
            goFullscreen()
        });

       document.addEventListener('fullscreenchange', function() {
            const activeSlide = Reveal.getCurrentSlide();
            const videos = activeSlide.querySelectorAll('video');
            videos.forEach(video => {
                if (!video.paused) {
                    video.play().catch(error => console.error("Error resuming video:", error));
                }
            });

            if (document.fullscreenElement) {
                resumeSlideshow(); // Resume slideshow when entering fullscreen
            } else {
                if (videos.length > 0 && Array.from(videos).some(v => !v.paused)) {
                    resumeSlideshow(); // Resume slideshow if videos were playing before exiting fullscreen
                }
            }
        });



    function resumeSlideshow() {
        const slide_Duration = 5000; // Define slide duration
        Reveal.configure({ autoSlide: slide_Duration }); // Resume auto-sliding with the predefined slide duration
    }
        // Handle visibility change events to pause/resume video playback
        document.addEventListener('visibilitychange', function() {
            const activeSlide = Reveal.getCurrentSlide();
            const videos = activeSlide.querySelectorAll('video');
            if (document.hidden) {
                videos.forEach(video => {
                    video.pause();
                });
            } else {
                videos.forEach(video => {
                    if (video.paused) {
                        video.play().catch(error => console.error("Error resuming video:", error));
                    }
                });
            }
        });
    });
</script>
</body>
</html>
